---
title: "Inference Coursework"
output: html_notebook
---



```{r}
cov <- read.table("covid19.csv", sep=",",header=TRUE)
# cov$CMODateCount #

# the simple model that allows for departure from unbounded exponential growth
N = function(t, n0, beta) {
  val = exp(n0)
  for (i in seq_along(beta)) {
    val = val * exp(beta[i]*t^i)
  }
  val
}
### Question 1 ###
# evaluates the negative log likelihood of the model
neg_loglike = function(y, theta) {
  n0 = theta[1]
  beta = theta[2:length(theta)]
  n = length(y)
  t = seq(-1, 1, length.out=n) # run from -1 to 1 so model is invariant to units that time is measure in so it doesn't matter if time is measure in seconds, days, or months.
  ll <-sum(dpois(y, N(t, n0, beta), log=TRUE))
  -ll
}

# function to work out AIC
AIC = function(num_par, val_ll) {
  2*val_ll + 2 * num_par # note that its not -2*val_ll since val_ll is already negative
}

### Question 2 ###
# fits models with values from 1 to 5, finds the MLE for theta, finds AIC
for (K in 1:5) {
  par = integer(K+1)
  
  #finds MLE for theta? does it? &&&&&&&&&&
  theta = optim(par=par, neg_loglike, method="BFGS", y=cov$CMODateCount)
  
  n0 = theta$par[1]
  beta = theta$par[2:length(theta$par)]
  
  t = seq(-1, 1, length.out=length(cov$CMODateCount))
  
  with(cov,plot(1:41,cov$CMODateCount, main = "Number of new cases per day from 31/01/2020 to 11/03/2020",xlab = "Day No.", ylab = "Number of new cases"))
  
  e = exp(n0)
  for (i in seq_along(beta)) {
    e = e * exp(beta[i] * t^i)
  }

  lines(1:length(cov$CMODateCount), e, col="red")
  legend("topleft", legend=paste("Model when K value = ", K), col="red", lty=1:2, cex=0.8)
  aic <- AIC(length(par), theta$value)
  cat("AIC for ", K, " is: ", aic, "\n")
}

```

```{r}
### Question 2 Continued ###
# We want to test whether the model when K=4 can be simplified or not.
# Null Hypothesis is when K = 3
K0 = 3
par = integer(K0+1)

# MLE for theta when K=3
theta0 = optim(par=par, loglike, method="BFGS", y=cov$CMODateCount)

#Alterantive Hypothesis is when K = 4
K1 = 4
par = integer(K1+1)

# MLE for theta when K=4
theta1 = optim(par=par, loglike, method="BFGS", y=cov$CMODateCount)

# t is the GLRT test statisic &&&&&&&&
t = 2 * (theta0$value - theta1$value)

# works out the &&&&&&&&&
p <- pchisq(t,df=1)

# &&&&&&&&7
1-p

# If this boolean outputs TRUE, which it does, we reject the null hypothesis (when K=3)
1-p < 0.05
 
```

```{r}

### Question 3 ###
K1 = 4
par = integer(K1+1)

theta1 = optim(par=par, loglike, method="BFGS", y=cov$CMODateCount, hessian = TRUE)

# the inverse of the hessian is the covariance matrix
covar = solve(theta1$hessian)
print("The approximate covariance matrix is: ", quote=FALSE)
covar
```

```{r}
### Question 4 ###
se <- sqrt(diag(covar))

ci.lower = rep(0,5)
ci.upper = rep(0,5)
for (i in 1:5) {
  ci.lower <- theta1$par[i]-1.96*se[i]
  ci.upper = theta1$par[i]+1.96*se[i]
}

print(" 95% confidence interval for estimates of log(N(t))", quote = FALSE)
cat("the lower bound is: ", sum(ci.lower), "\n")
cat("the upper bound is: ", sum(ci.upper), "\n")

```















